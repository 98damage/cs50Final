{% extends "layout.html" %}

{% block title %}
Recipe Generation
{% endblock %}

{% block main %}

{% if userDb_data[0]['titles_generated'] %}
<div class="container-md container-style">
    <!--Add if statment checking whether recipes have been generated to determine what to display-->
    <h1 class="mb-2">Personalised Recipes</h1>
    <h2 class="mb-2">Please select 7 recipes for your week</h2>
    <form action="{{ url_for('generate') }}" method="post">
        <input type="hidden" name="selected-recipes" id="selected-recipes-input" value="">
        <button type="submit" id="submit-recipes-btn" class="btn btn-lg btn-primary m-3 mx-auto">Add Recipes to Weekly
            Plan</button>
    </form>
</div>

<!--only visible after recipes have been generated-->
<div class="recipe-container">
    {% for recipe in recipes_db %}
    <div class="card text-start recipe-card">
        <div class="card-header">
            {{ recipe['cuisine'] }}
        </div>
        <div class="card-body">
            <h5 class="card-title">{{ recipe['title'] }}</h5>
            <p class="card-text">{{ recipe['meal_type'] }}</p>
            <button type="button" class="btn btn-sm btn-primary add-recipe-btn"
                recipeid="{{ recipe['id'] }}">Add</button>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selectedRecipes = new Set();
        const maxSelections = 7;

        const submitButton = document.getElementById('submit-recipes-btn');
        const addRecipeButtons = document.querySelectorAll('.add-recipe-btn');
        const hiddenInput = document.getElementById('selected-recipes-input');  // Reference to the hidden input field

        // Ensure the submit button is visible and initially disabled
        submitButton.style.display = 'block';
        submitButton.disabled = true;
        submitButton.classList.add('btn-secondary');  // Assume 'btn-secondary' is a greyed-out style

        addRecipeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const recipeid = this.getAttribute('recipeid');

                // Toggle selection
                if (selectedRecipes.has(recipeid)) {
                    selectedRecipes.delete(recipeid);
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-primary');
                    this.textContent = 'Add';
                } else if (selectedRecipes.size < maxSelections) {
                    selectedRecipes.add(recipeid);
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-danger');
                    this.textContent = 'Remove';
                }

                // Update the hidden input with the serialized array
                hiddenInput.value = JSON.stringify(Array.from(selectedRecipes));

                // Enable or disable the submit button based on the number of selections
                if (selectedRecipes.size === maxSelections) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('btn-secondary');
                    submitButton.classList.add('btn-primary');  // Change to the primary style when enabled
                } else {
                    submitButton.disabled = true;
                    submitButton.classList.remove('btn-primary');
                    submitButton.classList.add('btn-secondary');  // Greyed out when not enough selections
                }

                // Disable other buttons if 7 recipes are selected
                if (selectedRecipes.size >= maxSelections) {
                    addRecipeButtons.forEach(btn => {
                        if (!selectedRecipes.has(btn.getAttribute('recipeid'))) {
                            btn.disabled = true;
                            btn.classList.add('btn-secondary');
                        }
                    });
                } else {
                    addRecipeButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('btn-secondary');
                    });
                }
            });
        });

        // Submit button logic can stay the same if you're submitting the form traditionally
        // submitButton.addEventListener('click', function () {
        //     const selectedRecipesArray = Array.from(selectedRecipes);
        //     console.log('Selected recipes:', selectedRecipesArray);
        //     // Handle the submission logic (e.g., AJAX request or form submission)
        // });
    });

</script>



{% else %}
<div class="container-md container-style">
    <!--Add if statment checking whether recipes have been generated to determine what to display-->
    <h1 class="mb-2">Generate Weekly Recipes</h1>
    <h2 class="mb-2">Simply press the generate button below</h2>
</div>
<!--only visible before recipes have been generated-->
<div class="container text-start m-4">
    <img src="/static/indianCurry.jpg" alt="Indian Curry" width="300" height="300">
    <img src="/static/americanBurger.jpg" alt="American Burger" width="300" height="300">
    <img src="/static/japaneseFood.jpg" alt="Japanese Meal" width="300" height="300">
    <img src="/static/breakfast.jpg" alt="Breakfast" width="300" height="300">
</div>

<div class="d-grid gap-2 m-4">
    <form action="{{ url_for('generate') }}" method="post">
        <button class="btn btn-lg btn-primary" type="submit">Generate Recipes</button>
    </form>
</div>

{% endif %}

<!--IF RECIPES HAVE BEEN GENERATED BUT WEEKLY PLAN NOT CREATED-->
{% endblock %}